<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PEmbroider (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 12px; }
    .row { margin: 12px 0; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .layers { margin-top: 12px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .layer { display: grid; grid-template-columns: 1fr 120px 170px 140px 120px 120px; gap: 10px; padding: 10px; border-top: 1px solid #eee; align-items: center; }
    .layer:first-child { border-top: 0; }
    .layer code { font-size: 12px; }
    label { font-size: 14px; }
    input[type="number"]{ width: 90px; }
    input[type="range"]{ width: 140px; }
    input[type="password"]{ width: 180px; }
    button { padding: 10px 12px; }
    #status { font-weight: 600; }
    img { max-width: 100%; display: block; margin-top: 12px; border: 1px solid #ccc; border-radius: 6px; background: #f5f5f5; }
    .small { font-size: 12px; color: #555; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>PEmbroider (MVP)</h1>

  <div class="row">
    <label>
      Upload PNG layers:
      <input id="files" type="file" accept=".png" multiple />
    </label>

    <label>
      Class key:
      <input id="classKey" type="password" placeholder="x-class-key" />
    </label>

    <div class="actions">
      <button id="go" type="button">Generate</button>
      <span id="status"></span>
    </div>
  </div>

  <div class="row">
    <label>Canvas size:
      <select id="size">
        <option value="800">800×800</option>
        <option value="1000">1000×1000</option>
        <option value="1200">1200×1200</option>
      </select>
    </label>

    <label>Scale %:
      <input id="scale" type="number" min="10" max="100" step="5" value="100">
    </label>

    <label>Default spacing:
      <input id="spacing" type="number" min="1" max="20" step="1" value="4">
    </label>

    <label>Threshold:
      <input id="threshold" type="range" min="0" max="255" value="128">
      <span id="thresholdVal" class="small">128</span>
    </label>

    <label class="small">
      <input id="thresholdEnabled" type="checkbox" checked>
      Auto mask (threshold PNGs)
    </label>
    <label class="small">
      <input id="optimize" type="checkbox" checked>
      Optimize stitch order (slower)
    </label>
  </div>

  <div class="small">
    Tip: upload one PNG per colour region. Transparent background is fine.
  </div>

  <div id="layers" class="layers" style="display:none;"></div>

  <img id="preview" alt="Preview will appear here" />
  <div class="row">
    <a id="download" href="#" style="display:none;">Download PES</a>
  </div>

<script>
const PATTERNS = ["CONCENTRIC","CROSS","PARALLEL","SATIN","SPIRAL","PERLIN"];

const filesEl = document.getElementById("files");
const layersEl = document.getElementById("layers");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const downloadEl = document.getElementById("download");
const classKeyEl = document.getElementById("classKey");

const spacingEl = document.getElementById("spacing");
const sizeEl = document.getElementById("size");
const scaleEl = document.getElementById("scale");
const thresholdEl = document.getElementById("threshold");
const thresholdValEl = document.getElementById("thresholdVal");
const thresholdEnabledEl = document.getElementById("thresholdEnabled");
const optimizeEl = document.getElementById("optimize");

thresholdEl.addEventListener("input", () => {
  thresholdValEl.textContent = thresholdEl.value;
});

function hexToRgb(hex) {
  return [
    parseInt(hex.slice(1,3), 16),
    parseInt(hex.slice(3,5), 16),
    parseInt(hex.slice(5,7), 16),
  ];
}

function makePatternSelect(selected) {
  const s = document.createElement("select");
  for (const p of PATTERNS) {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    if (p === selected) opt.selected = true;
    s.appendChild(opt);
  }
  return s;
}

function renderLayerRows(fileList) {
  layersEl.innerHTML = "";

  const header = document.createElement("div");
  header.className = "layer";
  header.style.fontWeight = "700";
  header.innerHTML = `
    <div>Layer (PNG)</div>
    <div>Colour</div>
    <div>Pattern</div>
    <div>Angles (deg)</div>
    <div>Move</div>
    <div></div>
  `;
  layersEl.appendChild(header);

  Array.from(fileList).forEach((f, idx) => {
    const row = document.createElement("div");
    row.className = "layer";
    row.dataset.filename = f.name;

    const name = document.createElement("div");
    name.innerHTML = `<code>${f.name}</code>`;

    const color = document.createElement("input");
    color.type = "color";
    color.value = (idx % 2 === 0) ? "#ff0000" : "#00009b";

    const pattern = makePatternSelect(idx % 2 === 0 ? "CONCENTRIC" : "CROSS");

    const angles = document.createElement("div");
    angles.style.display = "flex";
    angles.style.gap = "6px";
    const a1 = document.createElement("input");
    a1.type = "number";
    a1.step = "1";
    a1.value = (idx % 2 === 0) ? 0 : 90;
    const a2 = document.createElement("input");
    a2.type = "number";
    a2.step = "1";
    a2.value = (idx % 2 === 0) ? 0 : 75;
    angles.appendChild(a1);
    angles.appendChild(a2);

    const move = document.createElement("div");
    move.style.display = "flex";
    move.style.gap = "6px";
    const up = document.createElement("button");
    up.type = "button";
    up.textContent = "↑";
    const down = document.createElement("button");
    down.type = "button";
    down.textContent = "↓";
    move.appendChild(up);
    move.appendChild(down);

    const remove = document.createElement("button");
    remove.type = "button";
    remove.textContent = "Remove";

    up.addEventListener("click", () => {
      const prev = row.previousElementSibling;
      if (prev && prev !== header) layersEl.insertBefore(row, prev);
    });
    down.addEventListener("click", () => {
      const next = row.nextElementSibling;
      if (next) layersEl.insertBefore(next, row);
    });
    remove.addEventListener("click", () => row.remove());

    row._controls = { color, pattern, a1, a2 };

    row.appendChild(name);
    row.appendChild(color);
    row.appendChild(pattern);
    row.appendChild(angles);
    row.appendChild(move);
    row.appendChild(remove);

    layersEl.appendChild(row);
  });

  layersEl.style.display = "block";
}

filesEl.addEventListener("change", () => {
  if (!filesEl.files.length) {
    layersEl.style.display = "none";
    layersEl.innerHTML = "";
    return;
  }
  renderLayerRows(filesEl.files);
});

document.getElementById("go").addEventListener("click", async () => {
  const files = filesEl.files;
  if (!files.length) return alert("Choose PNG files first.");

  const classKey = classKeyEl.value.trim();
  if (!classKey) return alert("Enter your class key first.");

  const rows = Array.from(layersEl.querySelectorAll(".layer"))
    .filter(el => el._controls);

  if (!rows.length) return alert("No layers to generate.");

  const size = parseInt(sizeEl.value, 10);
  const spacing = parseFloat(spacingEl.value);

  const scalePct = parseFloat(scaleEl.value);
  const designScale = Math.max(0.1, Math.min(1.0, (isFinite(scalePct) ? scalePct : 100) / 100));

  const threshold = parseInt(thresholdEl.value, 10);
  const thresholdEnabled = thresholdEnabledEl.checked;
  const optimize = optimizeEl.checked;

  const spec = {
    width: size,
    height: size,
    designScale: designScale,
    output: { format: "pes", filename: "design" },
    optimize: optimize,
    layers: rows.map((row) => {
      const { color, pattern, a1, a2 } = row._controls;
      return {
        file: row.dataset.filename,
        color: hexToRgb(color.value),
        pattern: pattern.value,
        spacing: spacing,
        angles: [parseFloat(a1.value), parseFloat(a2.value)],
        stitch: [10, 20, 0],
        thresholdEnabled,
        threshold
      };
    })
  };

  const form = new FormData();
  for (const f of files) form.append("files", f);
  form.append("spec", JSON.stringify(spec));

  statusEl.textContent = "Rendering…";
  previewEl.removeAttribute("src");
  downloadEl.style.display = "none";

  try {
    const r = await fetch("/api/jobs", {
      method: "POST",
      body: form,
      headers: { "x-class-key": classKey },
    });
    const j = await r.json();

    if (!r.ok) throw new Error(j.error || j.message || "Job creation failed");

    previewEl.src = j.previewUrl + "?t=" + Date.now();
    downloadEl.href = j.pesUrl;
    downloadEl.textContent = "Download PES";
    downloadEl.style.display = "inline";

    statusEl.textContent = "Done.";
  } catch (err) {
    statusEl.textContent = "";
    alert(err.message || String(err));
  }
});
</script>
</body>
</html>
